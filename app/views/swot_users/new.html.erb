<% provide(:title, 'Subscription') %>
<h1>Choose device you want to use.</h1>

<div class="row">
  <div id="items"> </div>
  <script>
           $(function () {
            $.ajax({
                url: "http://140.138.150.52/task_manager/v2/list",
                data: {
                        service_id: 60, 
                        service_secret: "a98fa6a13fe2ba98c28fa52dabcd9acd",
                        gwid: 1,                
                       },
                type:  "POST",
                dataType: "JSON",
               }).done(function(rep) {
               var item = rep.devices;
                 for (var i in item ){
                    $('#items').append('<div class = "col-md-4"><div class="panel panel-success well well-lg">'+item[i].device_name+'<br>'
                      + '<button data-device-id='+ item[i].shg_device_id  +' data-device-name='+ item[i].device_name +' type="button" class="btn btn-primary submit-device">'+ "submit" +'</button></div></div>');
                 }
               })
           });

           $('#items').on('click', '.submit-device', function (e) {
              e.preventDefault();

              var $thisBtn = $(this),
                  $thisDeviceId = $thisBtn.data("device-id"),
                  $thisDeviceName = $thisBtn.data("device-name");
                  console.log($thisDeviceId);
                  $.ajax({
                  url: "http://140.138.150.52/task_manager/v2/subscribe",
                  data: {
                        service_id: 60, 
                        service_secret: "a98fa6a13fe2ba98c28fa52dabcd9acd",
                        gwid: 1,
                        shg_device_id: $thisDeviceId,
                        type: "add"
                       },
                  type:  "POST",
                  dataType: "JSON",
                  }).done(function(rep) {
                    $thisBtn.closest("div[class^='panel']").remove();
                    $.ajax({
                    url: "http://140.138.150.57:3000/creation?dev_id="+$thisDeviceId+"&name="+$thisDeviceName,
                   
                    type: "get",
                    datatype: "text/plain",
                    })                
           });
          })
  </script>
</div>
